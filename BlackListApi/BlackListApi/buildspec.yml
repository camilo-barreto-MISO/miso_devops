version: 0.2

phases:
  install:
    runtime-versions:
      dotnet: 8.0
    commands:
      - echo "Instalando las dependencias necesarias"
  pre_build:
    commands:
      - echo "Restaurando las dependencias del proyecto..."
      - dotnet restore BlackListApi/BlackListApi/BlackListApi.csproj
  build:
    commands:
      - echo "Compilando la aplicación..."
      - dotnet build BlackListApi/BlackListApi/BlackListApi.csproj --configuration Release
  post_build:
    commands:
      - echo "Ejecutando las pruebas..."
      - dotnet test BlackListApi/Tests/Tests.csproj --configuration Release
      - echo "Generando archivos de publicación..."
      - dotnet publish BlackListApi/BlackListApi/BlackListApi.csproj --configuration Release -o output/publish
      - echo "Construyendo la imagen del contenedor..."
      - echo "Generando la imagen con tag = fcamilob/blacklistapi:$CODEBUILD_BUILD_NUMBER"
      - docker build -t fcamilob/blacklistapi:$CODEBUILD_BUILD_NUMBER -f BlackListApi/Dockerfile.ci .
      - echo "Autenticando en Docker Hub con el token de acceso..."
      - docker login -u $DOCKER_USERNAME --password $DOCKER_TOKEN
      - echo "Pushing la imagen al repositorio Docker Hub..."
      - docker push fcamilob/blacklistapi:$CODEBUILD_BUILD_NUMBER
      
artifacts:
  files:
    - '**/bin/Release/net8.0/publish/**/*'
  discard-paths: yes
  name: fcamilob/blacklistapi:$CODEBUILD_BUILD_NUMBER

cache:
  paths:
    - '**/obj/**'
    - '**/bin/**'

